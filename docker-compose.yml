version: '3.8'

services:
  postgres:
    image: postgres:14-alpine
    container_name: graph-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-graph}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-graph-node}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    command:
      - "postgres"
      - "-cshared_preload_libraries=pg_stat_statements"
      - "-cmax_connections=200"
      - "-cshared_buffers=256MB"
      - "-ceffective_cache_size=1GB"
      - "-cwork_mem=4MB"
      - "-cmaintenance_work_mem=64MB"
      - "-ccheckpoint_completion_target=0.9"
      - "-cwal_buffers=16MB"
      - "-cdefault_statistics_target=100"
      - "-crandom_page_cost=1.1"
      - "-ceffective_io_concurrency=200"
      - "-cmin_wal_size=1GB"
      - "-cmax_wal_size=4GB"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-graph}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - graph-network

  ipfs:
    image: ipfs/kubo:v0.24.0
    container_name: graph-ipfs
    ports:
      - "5001:5001"
      - "8080:8080"
    volumes:
      - ipfs_data:/data/ipfs
    environment:
      IPFS_PROFILE: server
    command:
      - daemon
      - --migrate=true
      - --enable-gc
    healthcheck:
      test: ["CMD-SHELL", "ipfs id || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - graph-network

  graph-node:
    image: graphprotocol/graph-node:v0.35.1
    container_name: graph-node
    ports:
      - "8000:8000"
      - "8001:8001"
      - "8020:8020"
      - "8030:8030"
      - "8040:8040"
    depends_on:
      postgres:
        condition: service_healthy
      ipfs:
        condition: service_healthy
    environment:
      postgres_host: postgres
      postgres_port: 5432
      postgres_user: ${POSTGRES_USER:-graph}
      postgres_pass: ${POSTGRES_PASSWORD}
      postgres_db: ${POSTGRES_DB:-graph-node}
      ipfs: 'ipfs:5001'
      ethereum: 'mantle-sepolia:${MANTLE_SEPOLIA_RPC}'
      GRAPH_LOG: ${GRAPH_LOG_LEVEL:-info}
      GRAPH_ETH_CALL_GAS: 50000000
      GRAPH_GETH_ETH_CALL_ERRORS: "out of gas"
      GRAPH_MAX_API_VERSION: 0.0.7
      ETHEREUM_REORG_THRESHOLD: 50
      ETHEREUM_ANCESTOR_COUNT: 50
      GRAPH_ETHEREUM_MAX_BLOCK_RANGE_SIZE: 2000
      GRAPH_ETHEREUM_TARGET_TRIGGERS_PER_BLOCK_RANGE: 100
      GRAPH_KILL_IF_UNRESPONSIVE: "true"
      GRAPH_ALLOW_NON_DETERMINISTIC_IPFS: ${GRAPH_ALLOW_NON_DETERMINISTIC_IPFS:-false}
    volumes:
      - graph_data:/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    networks:
      - graph-network

networks:
  graph-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  ipfs_data:
    driver: local
  graph_data:
    driver: local
